<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The End</title>
    <link rel="stylesheet" href="../resource/css/style.css">
    <link rel="stylesheet" href="../resource/css/class.css">
    <script type="module">
        import { play_problem_sfx, getRemovedChatters, showAchievementPopup } from '../resource/js/common.js';

        // Play problem SFX when ending loads
        document.addEventListener('DOMContentLoaded', function () {
            play_problem_sfx();

            // Create tombstones marquee if there are fallen chatters
            createTombstonesMarquee();

            const removedChatters = getRemovedChatters();

            let text = "[ESC]aping";
            let title = "Ending C ";

            if (Object.keys(removedChatters).length > 0) {
                title = "True " + title;
                text = "Dire Reality";

                let et = document.getElementById("ending-title");
                et.innerText = "True " + et.innerText;
                document.getElementById("ending-extra").classList.add("highlight-text");
                document.getElementById("ending-extra").style.fontSize = "38px";
                document.getElementById("ending-extra").style.textTransform = "uppercase";
            }

            // Show achievement popup on page load
            window.addEventListener('load', () => {
                showAchievementPopup(text, title);
            });
        });

        function createTombstonesMarquee() {
            const container = document.getElementById('tombstones-marquee');
            if (!container) return;

            // Get fallen chatters from localStorage
            const removedChatters = getRemovedChatters();
            const usernames = Object.keys(removedChatters);

            // If no fallen chatters, don't show the marquee container at all
            if (usernames.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Make container relative for absolute positioning and give it height
            container.style.position = 'relative';
            container.style.height = '160px';

            // Create marquee element
            const marquee = document.createElement('marquee');
            marquee.style.cssText = `
                position: fixed;
                left: 0;
                width: 100vw;
                height: 160px;
                padding: 10px 0;
                overflow: hidden;
                white-space: nowrap;
                z-index: 10;
            `;
            marquee.behavior = 'scroll';
            marquee.direction = 'left';
            marquee.scrollamount = '0.5';

            // Position it at the container's location
            const rect = container.getBoundingClientRect();
            marquee.style.top = rect.top + 'px';

            // Generate tombstones for removed usernames
            const tombstones = [];
            for (const username of usernames) {
                const message = removedChatters[username] || '';

                const tombstone = document.createElement('span');
                tombstone.style.cssText = `
                    display: inline-block;
                    background-color: #708090;
                    color: #fff;
                    border: 1px solid #999;
                    border-radius: 50% 50% 10px 10px;
                    width: 100px;
                    height: 140px;
                    padding: 5px 5px 8px;
                    margin: 0 12px;
                    font-family: 'MS Sans Serif', Tahoma, sans-serif;
                    font-size: 11px;
                    text-align: center;
                    vertical-align: top;
                    box-shadow: 3px 3px 6px rgba(0,0,0,0.7);
                    position: relative;
                    overflow: hidden;
                `;



                // Build tombstone content: RIP in top semicircle, text centered in bottom rectangle
                let content = `
                    <div style="position: absolute; top: 25px; left: 10px; font-size: 20px; font-weight: bold;" class="highlight-text">† R.I.P. †</div>
                    <div style="position: absolute; top: 75px; left: 50%; transform: translateX(-50%); width: 90%;">
                        <div style="font-weight: bold; font-size: 11px; margin-bottom: 4px;">${username}</div>
                `;
                if (message) {
                    content += `<div style="font-style: italic; font-size: 9px; line-height: 1.1; white-space: normal;">"${message}"</div>`;
                }
                content += `</div>`;
                tombstone.innerHTML = content;

                tombstones.push(tombstone);
            }

            // If no tombstones (shouldn't happen), show a message
            if (tombstones.length === 0) {
                const noTombstones = document.createElement('span');
                noTombstones.style.cssText = `
                    color: #fff;
                    font-family: 'MS Sans Serif', Tahoma, sans-serif;
                    font-size: 14px;
                `;
                noTombstones.textContent = 'No fallen chatters to remember...';
                marquee.appendChild(noTombstones);
            } else {
                // Add each tombstone once (no duplicates)
                tombstones.forEach(t => marquee.appendChild(t));
            }

            container.appendChild(marquee);

            // Show disclaimer positioned over the marquee
            const disclaimer = document.getElementById('disclaimer');
            disclaimer.textContent = 'DISCLAIMER: Although you let these Chat members die in your game, we have no reason to believe they actually died.';
            disclaimer.style.display = 'block';
            disclaimer.style.position = 'absolute';
            disclaimer.style.top = '50%';
            disclaimer.style.left = '50%';
            disclaimer.style.transform = 'translate(-50%, -50%)';
            disclaimer.style.opacity = '0.5';
            disclaimer.style.zIndex = '0';
            disclaimer.style.width = '80%';
            disclaimer.style.maxWidth = '600px';
        }
    </script>
</head>

<body
    style="background: linear-gradient(180deg, #008080 0%, #004040 100%); margin: 0; padding: 0; height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <div style="text-align: center; padding: 20px; overflow-x:hidden;position:absolute;left:0px;right:0px;">
        <div class="highlight-text" id="ending-title" style="font-size: 24px; margin-bottom: 20px;">Ending C</div>
        <h1
            style="font-family: 'MS Sans Serif', Tahoma, sans-serif; color: #fff; font-size: 36px; margin-bottom: 10px; line-height: 1.2;">
            [ESC]aping from <span id="ending-extra">reality</span>
        </h1>

        <div style="color: #FFF; display:inline-block">EPILOGUE (external links)<br />
            <a href="https://www.youtube.com/clip/UgkxicM0vcrL04JTq-PBkOnZNdSRdgAFu-MC" target="_blank"
                class="epilogue-link" style="font-size: 12px; display: inline-block; margin-bottom: 10px;">VIDEO</a> ...
            <a href="https://virtualvacation.us/guess" target="_blank" class="epilogue-link"
                style="font-size: 12px; display: inline-block; margin-bottom: 10px;">GAME</a>
        </div>

        <div style="margin-top: 10px;">
            <div id="tombstones-marquee" style="margin-bottom: 10px;"></div>
            <div id="disclaimer"
                style="margin-bottom: 10px; display: none; font-style: italic; font-size: 12px; color: #ccc; text-align: center;">
            </div>
            <a href="ending.html" class="next-button">
                <img src="../resource/icons/next.png" alt="Continue" />
                CONTINUE
            </a>
        </div>
    </div>
</body>

</html>